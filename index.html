<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NWS Forecast Widget (NYZ010)</title>
  <style>
    :root{
      --bg: #0b1220;
      --panel: #0f1a33;
      --text: #e8eefc;
      --muted: #aab8df;
      --border: rgba(255,255,255,.12);
      --colA: rgba(120, 170, 255, .18);
      --colB: rgba(255,255,255,.08);
      --accent: #7ab2ff;
      --danger: #ff6b6b;
      --ok: #39d98a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(122,178,255,.22), transparent 60%),
                  radial-gradient(900px 600px at 100% 0%, rgba(57,217,138,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: var(--font);
    }

    .widget{
      max-width: 1100px;
      margin: 16px auto;
      padding: 14px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card__header{
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
    }

    .title{
      display: grid;
      gap: 4px;
      min-width: 0;
    }

    .title h1{
      margin: 0;
      font-size: 16px;
      letter-spacing: .2px;
      font-weight: 650;
      line-height: 1.2;
    }

    .title .meta{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }

    .actions{
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 0 0 auto;
    }

    .btn{
      appearance: none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      user-select: none;
      white-space: nowrap;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn:hover{ background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn:focus-visible{ outline: 2px solid rgba(122,178,255,.7); outline-offset: 2px; }

    .status{
      padding: 10px 14px;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }

    .pill{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      white-space: nowrap;
    }

    .dot{
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--muted);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }

    .dot--ok{ background: var(--ok); }
    .dot--bad{ background: var(--danger); }

    /* Forecast columns */
    .columns{
      display: flex;
      gap: 10px;
      padding: 12px;
      overflow-x: auto;
      overscroll-behavior-x: contain;
      scroll-snap-type: x mandatory;
      scroll-padding: 12px;
      -webkit-overflow-scrolling: touch;
    }

    .col{
      flex: 0 0 auto;
      width: min(320px, calc(100vw - 60px));
      min-width: 240px;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      scroll-snap-align: start;
      background: rgba(255,255,255,.05);
    }

    .col--a{ background: var(--colA); }
    .col--b{ background: var(--colB); }

    .col__head{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display: grid;
      gap: 8px;
    }

    .col__name{
      font-size: 14px;
      font-weight: 700;
      letter-spacing: .2px;
      line-height: 1.2;
    }

    .col__badgeRow{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .badge{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: var(--text);
      line-height: 1;
      white-space: nowrap;
    }

    .badge strong{ font-weight: 800; }
    .badge .muted{ color: var(--muted); font-weight: 600; }

    .col__body{
      padding: 12px;
      font-size: 13px;
      line-height: 1.5;
      color: rgba(232,238,252,.92);
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: normal;
    }

    .hl-key{ font-weight: 800; color: #ffffff; }
    .hl-temp{
      font-weight: 850;
      color: #ffffff;
      background: rgba(122,178,255,.20);
      border: 1px solid rgba(122,178,255,.35);
      padding: 0 6px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .error{
      margin: 12px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,107,107,.35);
      background: rgba(255,107,107,.10);
      color: rgba(255,255,255,.92);
      display: none;
    }
    .error strong{ color: #fff; }
    .error code{
      display: inline-block;
      padding: 2px 6px;
      border-radius: 8px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      font-family: var(--mono);
      font-size: 12px;
    }

    /* Lower layout (Radar + Alerts) */
    .lower{
      padding: 12px;
      border-top: 1px solid var(--border);
    }

    .lower__grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: start;
    }

    .panelbox{
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      overflow: hidden;
      background: rgba(255,255,255,.05);
    }

    .panelbox__header{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      flex-wrap: wrap;
    }

    .panelbox__title{
      margin: 0;
      font-size: 14px;
      font-weight: 750;
      letter-spacing: .2px;
      line-height: 1.2;
    }

    .panelbox__meta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    /* Radar */
    .radar__frame{
      background: rgba(0,0,0,.18);
    }
    .radar__img{
      display: block;
      width: 100%;
      height: auto;
    }

    /* Alerts */
    .alerts__status{
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 12px;
    }

    .alerts__scroll{
      max-height: 320px;
      overflow: auto;
      padding: 10px;
      -webkit-overflow-scrolling: touch;
    }

    .alerts__empty{
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 12px;
      padding: 12px;
      color: rgba(232,238,252,.88);
      background: rgba(0,0,0,.12);
      font-size: 13px;
      line-height: 1.45;
    }

    details.alert-card{
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      background: rgba(0,0,0,.14);
      overflow: hidden;
      margin-bottom: 10px;
    }

    details.alert-card:last-child{ margin-bottom: 0; }

    details.alert-card > summary{
      list-style: none;
      cursor: pointer;
      padding: 10px 10px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 10px;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    details.alert-card > summary::-webkit-details-marker{ display:none; }

    details.alert-card > summary:focus-visible{
      outline: 2px solid rgba(122,178,255,.7);
      outline-offset: 2px;
    }

    .sev-badge{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      font-size: 12px;
      font-weight: 800;
      white-space: nowrap;
      background: rgba(255,255,255,.08);
    }

    /* Severity emphasis (kept subtle; still dark-mode friendly) */
    .sev-extreme{ border-color: rgba(255,107,107,.55); background: rgba(255,107,107,.14); color: #fff; }
    .sev-severe{ border-color: rgba(255,107,107,.40); background: rgba(255,107,107,.10); color: #fff; }
    .sev-moderate{ border-color: rgba(122,178,255,.45); background: rgba(122,178,255,.12); color: #fff; }
    .sev-minor{ border-color: rgba(57,217,138,.40); background: rgba(57,217,138,.10); color: #fff; }
    .sev-unknown{ border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.06); color: rgba(232,238,252,.92); }

    .alert-title{
      font-size: 13px;
      font-weight: 750;
      line-height: 1.25;
      color: rgba(232,238,252,.96);
      overflow-wrap: anywhere;
    }

    .alert-until{
      font-size: 12px;
      color: var(--muted);
      text-align: right;
      white-space: nowrap;
    }

    .alert-body{
      padding: 10px 12px 12px;
      font-size: 13px;
      line-height: 1.5;
      color: rgba(232,238,252,.92);
    }

    .kv{
      display: grid;
      gap: 8px;
    }

    .kv__row{
      display: grid;
      grid-template-columns: 84px 1fr;
      gap: 10px;
      align-items: start;
    }

    .kv__k{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: .15px;
    }

    .kv__v{
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }

    .alert-metaLine{
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .alert-link{
      color: rgba(232,238,252,.92);
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    /* Responsive */
    @media (max-width: 900px){
      .lower__grid{ grid-template-columns: 1fr; }
    }

    @media (max-width: 560px){
      .card__header{
        flex-direction: column;
        align-items: stretch;
      }
      .actions{
        justify-content: flex-start;
      }
      .title .meta{ white-space: normal; }

      details.alert-card > summary{
        grid-template-columns: auto 1fr;
        grid-template-rows: auto auto;
      }
      .alert-until{
        grid-column: 1 / -1;
        text-align: left;
        white-space: normal;
      }
      .kv__row{
        grid-template-columns: 76px 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="widget">
    <div class="card" role="region" aria-label="National Weather Service weather dashboard">
      <div class="card__header">
        <div class="title">
          <h1>NWS Forecast — Zone NYZ010</h1>
          <div class="meta" id="metaLine">Source: api.weather.gov</div>
        </div>
        <div class="actions">
          <button class="btn" id="refreshBtn" type="button" aria-label="Refresh forecast">Refresh</button>
          <a class="btn" id="openApiBtn" href="https://api.weather.gov/zones/forecast/NYZ010/forecast" target="_blank" rel="noopener noreferrer" aria-label="Open the forecast endpoint in a new tab">Open Forecast API</a>
        </div>
      </div>

      <div class="status" aria-live="polite">
        <span class="pill">
          <span class="dot" id="statusDot" aria-hidden="true"></span>
          <span id="statusText">Loading…</span>
        </span>
        <span id="updatedText" class="meta"></span>
      </div>

      <div class="error" id="errorBox" role="alert"></div>

      <div class="columns" id="columns" tabindex="0" aria-label="Forecast periods (horizontally scrollable)">
        <!-- Forecast columns injected here -->
      </div>

      <div class="lower" aria-label="Radar and alerts">
        <div class="lower__grid">
          <!-- Radar -->
          <section class="panelbox" aria-label="Radar loop">
            <div class="panelbox__header">
              <h3 class="panelbox__title">KBUF Buffalo Radar Loop</h3>
              <span class="panelbox__meta">Source: NWS Buffalo</span>
            </div>
            <div class="radar__frame">
              <img
                class="radar__img"
                src="https://radar.weather.gov/ridge/standard/KBUF_loop.gif"
                alt="Animated radar loop for Buffalo (KBUF) from the National Weather Service"
                loading="lazy"
                decoding="async"
              />
            </div>
          </section>

          <!-- Alerts -->
          <section class="panelbox" aria-label="Weather Alerts">
            <div class="panelbox__header">
              <h3 class="panelbox__title">Weather Alerts</h3>
              <a class="btn" href="https://api.weather.gov/alerts/active/zone/NYZ010" target="_blank" rel="noopener noreferrer" aria-label="Open alerts endpoint in a new tab">Open Alerts API</a>
            </div>

            <div class="alerts__status" aria-live="polite">
              <span class="pill">
                <span class="dot" id="alertsDot" aria-hidden="true"></span>
                <span id="alertsStatusText">Loading alerts…</span>
              </span>
              <span id="alertsUpdatedText"></span>
            </div>

            <div class="alerts__scroll" id="alertsScroll" aria-label="Scrollable list of active alerts">
              <!-- Alerts injected here -->
            </div>
          </section>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      // Forecast
      const FORECAST_ENDPOINT = "https://api.weather.gov/zones/forecast/NYZ010/forecast";

      /**
       * If you are getting HTTP 403 from api.weather.gov in a browser context,
       * you will need a tiny proxy that adds a compliant User-Agent on the server side.
       * Flip this to true and set PROXY_URL to your proxy route.
       */
      const USE_PROXY = false;
      const PROXY_URL = "http://localhost:8787/nws?url="; // Example; adjust to your proxy.

      // Alerts (per your requirement: NO custom headers)
      const ALERTS_URL = "https://api.weather.gov/alerts/active/zone/NYZ010";
      const ALERTS_POLL_MS = 60_000;

      const els = {
        // Forecast
        columns: document.getElementById("columns"),
        refreshBtn: document.getElementById("refreshBtn"),
        statusText: document.getElementById("statusText"),
        statusDot: document.getElementById("statusDot"),
        updatedText: document.getElementById("updatedText"),
        metaLine: document.getElementById("metaLine"),
        errorBox: document.getElementById("errorBox"),

        // Alerts
        alertsScroll: document.getElementById("alertsScroll"),
        alertsDot: document.getElementById("alertsDot"),
        alertsStatusText: document.getElementById("alertsStatusText"),
        alertsUpdatedText: document.getElementById("alertsUpdatedText"),
      };

      // ---------- Shared helpers ----------
      function safeText(s) { return (s ?? "").toString(); }

      function escapeHtml(s) {
        return safeText(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function formatUpdated(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return safeText(iso);
        return new Intl.DateTimeFormat(undefined, {
          weekday: "short",
          month: "short",
          day: "2-digit",
          hour: "numeric",
          minute: "2-digit"
        }).format(d);
      }

      function fmtTimeLocale(iso) {
        if (!iso) return "";
        const d = new Date(iso);
        return Number.isNaN(d.getTime()) ? "" : d.toLocaleString();
      }

      // ---------- Forecast ----------
      function setForecastStatus(state, message) {
        els.statusText.textContent = message;
        els.statusDot.classList.remove("dot--ok", "dot--bad");
        if (state === "ok") els.statusDot.classList.add("dot--ok");
        if (state === "error") els.statusDot.classList.add("dot--bad");
      }

      function showForecastError(htmlMessage) {
        els.errorBox.style.display = "block";
        els.errorBox.innerHTML = htmlMessage;
      }

      function clearForecastError() {
        els.errorBox.style.display = "none";
        els.errorBox.innerHTML = "";
      }

      function highlightForecastText(text) {
        let t = escapeHtml(text);

        t = t.replace(/\b(Highs?|Lows?)\b/gi, '<span class="hl-key">$1</span>');
        t = t.replace(/\b(near|around|to)\s(-?\d{1,3})\b/gi, '$1 <span class="hl-temp">$2°</span>');
        t = t.replace(/\b(-?\d{1,3})\sdegrees?\b/gi, '<span class="hl-temp">$1°</span>');

        return t;
      }

      function renderForecast(periods, meta) {
        els.columns.innerHTML = "";

        periods.forEach((p, i) => {
          const name = safeText(p.name) || "Forecast";
          const detailed = safeText(p.detailedForecast);
          const temp = (p.temperature !== null && p.temperature !== undefined)
            ? `${p.temperature}°${safeText(p.temperatureUnit)}`
            : null;
          const short = safeText(p.shortForecast);

          const col = document.createElement("section");
          col.className = `col ${i % 2 === 0 ? "col--a" : "col--b"}`;
          col.setAttribute("aria-label", name);

          col.innerHTML = `
            <div class="col__head">
              <div class="col__name">${escapeHtml(name)}</div>
              <div class="col__badgeRow">
                ${temp ? `<span class="badge" aria-label="Temperature"><strong>${escapeHtml(temp)}</strong> <span class="muted">temp</span></span>` : ""}
                ${short ? `<span class="badge" aria-label="Short forecast">${escapeHtml(short)}</span>` : ""}
              </div>
            </div>
            <div class="col__body">${highlightForecastText(detailed || "No detailed forecast provided.")}</div>
          `;

          els.columns.appendChild(col);
        });

        els.metaLine.textContent =
          `Source: api.weather.gov • Zone: ${safeText(meta?.zone || "NYZ010")}` +
          (USE_PROXY ? " • Mode: proxy" : " • Mode: direct");
      }

      async function fetchForecast() {
        clearForecastError();
        setForecastStatus("loading", "Loading…");
        els.updatedText.textContent = "";

        const url = USE_PROXY ? (PROXY_URL + encodeURIComponent(FORECAST_ENDPOINT)) : FORECAST_ENDPOINT;

        try {
          // Keep headers SIMPLE to avoid CORS preflight.
          const res = await fetch(url, {
            method: "GET",
            mode: "cors",
            cache: "no-store",
            headers: {
              "Accept": "application/geo+json"
            }
          });

          if (!res.ok) {
            if (res.status === 403 && !USE_PROXY) {
              throw new Error("HTTP 403 (Forbidden). See note below.");
            }
            throw new Error(`HTTP ${res.status} ${res.statusText}`);
          }

          const data = await res.json();
          const props = data?.properties;
          const periods = props?.periods;

          if (!Array.isArray(periods) || periods.length === 0) {
            throw new Error("No forecast periods returned by the API.");
          }

          const updatedFmt = formatUpdated(props?.updated);
          if (updatedFmt) els.updatedText.textContent = `Updated: ${updatedFmt}`;

          setForecastStatus("ok", "Live");
          renderForecast(periods, { zone: props?.zone });

        } catch (err) {
          setForecastStatus("error", "Error");
          els.columns.innerHTML = "";

          const msg = safeText(err?.message || err);
          const is403 = msg.includes("403");

          if (is403 && !USE_PROXY) {
            showForecastError(
              `<strong>Blocked by NWS (403).</strong><br/>
               In a browser, JavaScript cannot set a custom <code>User-Agent</code>, and the NWS may deny requests that don’t include an app-identifying UA string.<br/>
               Fix: use a tiny server-side proxy that adds the required <code>User-Agent</code>, then set <code>USE_PROXY = true</code> in this file.`
            );
          } else {
            showForecastError(
              `<strong>Could not load the forecast.</strong><br/>
               ${escapeHtml(msg)}<br/><br/>
               Try refreshing, or open the endpoint directly from the button above.`
            );
          }
        }
      }

      // ---------- Alerts (NO custom headers) ----------
      function severityRank(s) {
        const map = { Extreme: 4, Severe: 3, Moderate: 2, Minor: 1 };
        return map[s] ?? 0;
      }

      function severityClass(s) {
        const v = safeText(s).trim();
        if (v === "Extreme") return "sev-extreme";
        if (v === "Severe") return "sev-severe";
        if (v === "Moderate") return "sev-moderate";
        if (v === "Minor") return "sev-minor";
        return "sev-unknown";
      }

      function pickTitle(p) {
        const h = safeText(p?.headline).trim();
        const e = safeText(p?.event).trim();
        return h || e || "Weather Alert";
      }

      function setAlertsStatus(state, message) {
        els.alertsStatusText.textContent = message;
        els.alertsDot.classList.remove("dot--ok", "dot--bad");
        if (state === "ok") els.alertsDot.classList.add("dot--ok");
        if (state === "error") els.alertsDot.classList.add("dot--bad");
      }

      function renderAlerts(alerts, checkedAt) {
        els.alertsScroll.innerHTML = "";

        if (!alerts || alerts.length === 0) {
          const empty = document.createElement("div");
          empty.className = "alerts__empty";
          empty.innerHTML = `
            <div><strong>No active alerts for NYZ010</strong></div>
            ${checkedAt ? `<div style="margin-top:6px;color:rgba(170,184,223,.95)">Last checked: ${escapeHtml(checkedAt)}</div>` : ""}
          `;
          els.alertsScroll.appendChild(empty);
          return;
        }

        for (const a of alerts) {
          const details = document.createElement("details");
          details.className = "alert-card";

          const untilText = a.until ? `Until ${a.until}` : "";
          const title = a.title || "Weather Alert";

          const webLink = a.web ? `<a class="alert-link" href="${escapeHtml(a.web)}" target="_blank" rel="noopener noreferrer">Open alert</a>` : "";

          const instructionBlock = a.instruction
            ? `<div class="kv__row"><div class="kv__k">Instructions</div><div class="kv__v">${escapeHtml(a.instruction)}</div></div>`
            : "";

          const areaBlock = a.area
            ? `<div class="kv__row"><div class="kv__k">Area</div><div class="kv__v">${escapeHtml(a.area)}</div></div>`
            : "";

          const descBlock = a.description
            ? `<div class="kv__row"><div class="kv__k">Description</div><div class="kv__v">${escapeHtml(a.description)}</div></div>`
            : "";

          const metaBits = [];
          if (a.urgency) metaBits.push(`Urgency: ${escapeHtml(a.urgency)}`);
          if (a.certainty) metaBits.push(`Certainty: ${escapeHtml(a.certainty)}`);
          if (a.status) metaBits.push(`Status: ${escapeHtml(a.status)}`);
          if (a.messageType) metaBits.push(`Type: ${escapeHtml(a.messageType)}`);

          details.innerHTML = `
            <summary>
              <span class="sev-badge ${severityClass(a.severity)}">${escapeHtml(a.severity || "Unknown")}</span>
              <span class="alert-title">${escapeHtml(title)}</span>
              <span class="alert-until">${escapeHtml(untilText)}</span>
            </summary>
            <div class="alert-body">
              <div class="kv">
                ${areaBlock}
                ${descBlock}
                ${instructionBlock}
              </div>

              <div class="alert-metaLine">
                ${a.sent ? `<span>Sent: ${escapeHtml(a.sent)}</span>` : ""}
                ${a.effective ? `<span>Effective: ${escapeHtml(a.effective)}</span>` : ""}
                ${webLink ? `<span>${webLink}</span>` : ""}
              </div>

              ${metaBits.length ? `<div class="alert-metaLine">${metaBits.map(x => `<span>${x}</span>`).join("")}</div>` : ""}
            </div>
          `;

          els.alertsScroll.appendChild(details);
        }
      }

      async function loadAlerts() {
        setAlertsStatus("loading", "Loading alerts…");
        els.alertsUpdatedText.textContent = "";

        try {
          // Per requirement: do not add custom headers. Keep fetch plain.
          const res = await fetch(ALERTS_URL, {
            method: "GET",
            mode: "cors",
            cache: "no-store"
          });

          if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);

          const data = await res.json();
          const features = Array.isArray(data?.features) ? data.features : null;
          if (!features) throw new Error("Malformed alert payload: missing features[]");

          const alerts = features.map((f) => {
            const p = f?.properties ?? {};
            const untilISO = p.ends || p.expires || null;

            // Links: @id or uri (optional)
            const web = safeText(p?.["@id"] || p?.uri).trim() || "";

            return {
              id: f?.id || p?.id || `${safeText(p.sent)}-${safeText(p.event)}` || `alert-${Math.random().toString(16).slice(2)}`,
              title: pickTitle(p),
              event: safeText(p.event),
              severity: safeText(p.severity) || "Unknown",
              urgency: safeText(p.urgency),
              certainty: safeText(p.certainty),
              status: safeText(p.status),
              messageType: safeText(p.messageType),
              area: safeText(p.areaDesc),
              sentISO: safeText(p.sent),
              sent: fmtTimeLocale(p.sent),
              effective: fmtTimeLocale(p.effective),
              until: fmtTimeLocale(untilISO),
              description: safeText(p.description),
              instruction: safeText(p.instruction),
              web
            };
          });

          alerts.sort((a, b) => {
            const sr = severityRank(b.severity) - severityRank(a.severity);
            if (sr !== 0) return sr;

            const at = a.sentISO ? new Date(a.sentISO).getTime() : 0;
            const bt = b.sentISO ? new Date(b.sentISO).getTime() : 0;
            return bt - at;
          });

          const checkedAt = new Date().toLocaleString();
          els.alertsUpdatedText.textContent = `Last checked: ${checkedAt}`;
          setAlertsStatus("ok", alerts.length ? `${alerts.length} active` : "None");
          renderAlerts(alerts, checkedAt);

        } catch (err) {
          setAlertsStatus("error", "Alerts unavailable");
          const checkedAt = new Date().toLocaleString();
          els.alertsUpdatedText.textContent = `Last checked: ${checkedAt}`;
          renderAlerts([], checkedAt);
        }
      }

      // ---------- Wire up ----------
      els.refreshBtn.addEventListener("click", () => {
        fetchForecast();
        loadAlerts();
      });

      // Initial loads
      fetchForecast();
      loadAlerts();

      // Poll alerts no faster than every 60s (conservative)
      setInterval(loadAlerts, ALERTS_POLL_MS);
    })();
  </script>
</body>
</html>
